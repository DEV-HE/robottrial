<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: app.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: app.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Carga las variables de entorno desde un archivo .env.
require("dotenv").config();

// Importa las funciones y constantes necesarias para crear y configurar el bot.
const {
  createBot,
  createProvider,
  createFlow,
  addKeyword,
  EVENTS,
} = require("@bot-whatsapp/bot");

// Importa el m贸dulo para la interfaz de portal web para QR.
const QRPortalWeb = require("@bot-whatsapp/portal");

// Importa la funci贸n de inicializaci贸n para el plugin de OpenAI.
const { init } = require("bot-ws-plugin-openai");

// Importa el proveedor de servicios de Baileys para WhatsApp.
const BaileysProvider = require("@bot-whatsapp/provider/baileys");

// Importa el adaptador Mock para simular una base de datos.
const MockAdapter = require("@bot-whatsapp/database/mock");

// Importa la funci贸n handlerAI para el procesamiento de IA.
const { handlerAI } = require("./utils");

// Importa la funci贸n textToVoice para convertir texto en voz.
const { textToVoice } = require("./services/eventlab");

// Configuraci贸n para el addon de empleados, especificando el modelo de OpenAI y otros par谩metros.
const employeesAddonConfig = {
  model: "gpt-3.5-turbo-0301",
  temperature: 0,
  apiKey: process.env.OPENAI_API_KEY,
};

// Inicializa el addon de empleados con la configuraci贸n previa.
const employeesAddon = init(employeesAddonConfig);

/**
 * Define el flujo de interacci贸n para el staff, que incluye la conversi贸n de texto a voz y el env铆o de audios a trav茅s de la mensajer铆a.
 * Utiliza una combinaci贸n de acciones personalizadas y funciones asincr贸nicas para procesar y enviar mensajes de audio.
 * 
 * @param {Object} EVENTS - Objeto que contiene eventos, como acciones que desencadenan este flujo.
 * @returns {Object} Retorna un objeto de flujo configurado con palabras clave, respuestas y una funci贸n para manejar la l贸gica espec铆fica.
 */
const flowStaff = addKeyword(EVENTS.ACTION).addAnswer(
  ["驴Claro que te interesa?", "mejor te env铆o audio.."],
  null,
  /**
   * Funci贸n asincr贸nica que maneja la conversi贸n de texto a voz y el env铆o de audios.
   * Registra el proceso en la consola y maneja posibles errores.
   * 
   * @param {Object} ctx - Contexto del evento, incluye informaci贸n relevante para el proceso.
   * @param {Object} params - Contiene objetos espec铆ficos para este flujo, como `flowDynamic`, `state`, y `provider`.
   * @param {Function} params.flowDynamic - Funci贸n para dinamizar el flujo, no utilizada actualmente.
   * @param {Object} params.state - Objeto para gestionar el estado actual del flujo.
   * @param {Object} params.provider - Objeto proveedor para obtener instancias necesarias para el env铆o de mensajes.
   */
  async (ctx, { flowDynamic, state, provider }) => {
    console.log(" texto a voz....");
    try {
      // Obtiene el estado actual y convierte el texto de respuesta a voz.
      const currentState = state.getMyState();
      const path = await textToVoice(currentState.answer);
      console.log(` Fin texto a voz....[PATH]:${path}`);
      
      // Preparaci贸n para enviar el audio, no se env铆a en este c贸digo comentado.
      // await flowDynamic({ body: "escucha", media: path });

      // Obtiene el ID del chat y la instancia del proveedor para enviar el mensaje.
      const id = ctx.key.remoteJid;
      const sock = await provider.getInstance();
      await sock.sendMessage(
        id, 
        { audio: { url: path}, mimetype: 'audio/mp4'},
        // { url: path }, // Se pueden enviar formatos mp3, mp4 y ogg.
      );

    } catch (error) {
      if (error) {
        console.error("Error en flowStaff:", error);
      } else {
        console.error("Error en flowStaff: El error es undefined, revisa la funci贸n textToVoice.");
      }
    }
  }
);





/**
 * Define el flujo de interacci贸n para las notas de voz, incluyendo la conversi贸n de voz a texto.
 * Este flujo comienza con un mensaje inicial, luego intenta convertir la entrada de voz en texto
 * utilizando `handlerAI`, actualiza el estado con la respuesta generada, y redirige el flujo
 * seg煤n la determinaci贸n del empleado basado en la respuesta completa.
 * 
 * @param {Object} EVENTS - Un objeto que contiene tipos de eventos, incluyendo `VOICE_NOTE`.
 * @returns {Object} Una instancia del flujo configurado, listo para ser utilizado en la aplicaci贸n.
 */
const flowVoiceNote = addKeyword(EVENTS.VOICE_NOTE).addAction(
  /**
   * Acci贸n as铆ncrona ejecutada como parte del flujo de notas de voz.
   * Intenta procesar una entrada de voz para convertirla en texto, maneja el estado actual,
   * y dirige el flujo hacia el pr贸ximo paso basado en la respuesta.
   * 
   * @param {Object} ctx - El contexto actual de la ejecuci贸n, que puede contener informaci贸n variada como el estado actual.
   * @param {Function} ctxFn - Objeto de funciones de contexto para manipular estados y ejecutar flujos din谩micos.
   */
  async (ctx, ctxFn) => {
    try {
      // Informa al usuario que se iniciar谩 el proceso de escucha y conversi贸n de voz a texto.
      await ctxFn.flowDynamic("dame un momento para escucharte...");
      console.log(" voz a texto....");

      // Intenta convertir la voz en texto.
      const text = await handlerAI(ctx);
      console.log(` Fin voz a voz a texto....[TEXT]: ${text}`);

      // Recupera el estado actual para formular una respuesta completa.
      const currentState = ctxFn.state.getMyState();
      console.log("QUIERO VER QU ES CTX", ctx, "FIN DE CTX")
      const fullSentence = `${currentState?.answer ?? ""}. ${text}`;

      // Determina el empleado y la respuesta adecuados basados en la oraci贸n completa.
      const { employee, answer } = await employeesAddon.determine(fullSentence);

      // Actualiza el estado con la nueva respuesta y redirige el flujo.
      ctxFn.state.update({ answer });
      employeesAddon.gotoFlow(employee, ctxFn);
    } catch (error) {
      console.error("Error en flowVoiceNote:", error);
    }
  }
);

/**
 * Funci贸n principal que inicializa y configura el bot.
 * Esta funci贸n asincr贸nica realiza las siguientes operaciones:
 * - Inicializa el adaptador de base de datos utilizando `MockAdapter`.
 * - Crea un flujo de procesos con `createFlow`, integrando `flowVoiceNote` y `flowStaff`.
 * - Establece el proveedor del servicio mediante `createProvider`, usando `BaileysProvider` como proveedor.
 * - Define y configura los empleados digitales, los cuales son representantes virtuales especializados en diversas 谩reas.
 * - Inicia el bot con una configuraci贸n espec铆fica que incluye flujo de trabajo, proveedor de servicio y base de datos.
 * - Activa `QRPortalWeb` para la interacci贸n inicial o autenticaci贸n.
 * 
 * @async
 * @function main
 * @returns {Promise&lt;void>} No retorna ning煤n valor.
 */
const main = async () => {
  // Inicializa el adaptador de base de datos.
  const adapterDB = new MockAdapter();

  // Crea un flujo de trabajo con los procesos especificados.
  const adapterFlow = createFlow([flowVoiceNote, flowStaff]);

  // Establece el proveedor del servicio.
  const adapterProvider = createProvider(BaileysProvider);

  /**
   * Define los empleados digitales, cada uno con un nombre, descripci贸n,
   * y flujo de trabajo asignado. Por ejemplo, un empleado especializado en finanzas
   * ofrece servicios de contabilidad, facturaci贸n, y asesoramiento personalizado.
   * @type {Array&lt;Object>}
   */
  const employees = [
    {
      name: "SOY HCTOR Y TE PUEDO AYUDAR CON TUS FINANZAS",
      description:
        "Soy un representante de VOZ FINANZAS, una empresa que brinda soluciones integrales de alto valor para el crecimiento y gesti贸n eficiente de tu negocio. Ofrecemos servicios avanzados de contabilidad y facturaci贸n, gesti贸n de tr谩mites para el registro de marcas y constituci贸n de sociedades, as铆 como evaluaciones exhaustivas de archivos y asesoramiento contable personalizado. Nuestro enfoque est谩 en optimizar tu operaci贸n comercial, asegurando que cada aspecto de tu gesti贸n financiera sea impecable. Adem谩s, te brindamos herramientas para la toma de decisiones estrat茅gicas, apoyo en la planificaci贸n fiscal y estrategias para mejorar la eficiencia operativa. Nuestro equipo de expertos est谩 comprometido con ofrecer soluciones a medida que se adaptan a las necesidades 煤nicas de tu empresa, garantizando no solo el cumplimiento de las obligaciones legales y fiscales sino tambi茅n impulsando el crecimiento sostenible de tu negocio. Con VOZ FINANZAS, obtienes un aliado estrat茅gico que utiliza la 煤ltima tecnolog铆a y las mejores pr谩cticas del sector para darte una ventaja competitiva en el mercado. Estamos aqu铆 para resolver cualquier duda y ayudarte a navegar los desaf铆os de tu empresa con confianza y 茅xito.",
      flow: flowStaff,
    }
  ];

  // Configura los empleados digitales en el addon correspondiente.
  employeesAddon.employees(employees);

  // Inicia el bot con la configuraci贸n especificada.
  createBot({
    flow: adapterFlow,
    provider: adapterProvider,
    database: adapterDB,
  });

  // Activa el portal web para QR, utilizado en procesos de autenticaci贸n inicial o vinculaci贸n.
  QRPortalWeb()
};


// Llama a la funci贸n principal para ejecutar el bot.
main();</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#flowStaff">flowStaff</a></li><li><a href="global.html#flowVoiceNote">flowVoiceNote</a></li><li><a href="global.html#main">main</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Mon Mar 18 2024 20:46:49 GMT-0600 (hora est谩ndar central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
